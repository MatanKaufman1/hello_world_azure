trigger:
  - main

pool:
  name: matanAgent

variables:
  buildConfiguration: 'Release'
  artifactName: 'feed-matan'
  artifactVersion: '1.0.$(Build.BuildId)-$(Build.SourceBranchName)'
<<<<<<< HEAD
  jdkFile: '/home/ubuntu/temp/jdk-17_linux-x64_bin.tar.gz'  
=======
  jdkFile: '/home/ubuntu/temp/jre-8u431-linux-x64.tar.gz'
>>>>>>> 4e378e0bab09e0d03b6ae5744ed1dc8f02f4de02

jobs:
  - job: Build_Job
    steps:
      - checkout: self
        fetchDepth: 0

      - task: UseDotNet@2
        inputs:
          packageType: 'sdk'
          version: '8.x'
          installationPath: $(Agent.ToolsDirectory)/dotnet

      - task: NuGetToolInstaller@1
        displayName: 'Install NuGet Tool'

      - task: JavaToolInstaller@0
        inputs:
          versionSpec: '21'
          jdkArchitectureOption: 'x64'
          jdkSourceOption: 'LocalDirectory'
          jdkFile: $(jdkFile)
      

      - task: NuGetAuthenticate@1
        displayName: 'Authenticate with Azure Artifacts'

      - task: DotNetCoreCLI@2
        displayName: 'Restore Dependencies'
        inputs:
          command: 'restore'
          projects: '/home/ubuntu/azure-helloWorld.csproj'

      - task: DotNetCoreCLI@2
        displayName: 'Build Project'
        inputs:
          command: 'build'
          projects: '/home/ubuntu/azure-helloWorld.csproj'
          arguments: '--configuration $(buildConfiguration)'

      - task: SonarQubeAnalyze@6
        displayName: 'Run SonarQube Analysis'

      - task: SonarQubePublish@6
        inputs:
          pollingTimeoutSec: '300'
        displayName: 'Publish SonarQube Results'

      - task: DotNetCoreCLI@2
        displayName: 'Pack Project'
        inputs:
          command: 'pack'
          projects: '/home/ubuntu/azure-helloWorld.csproj'
          outputDir: '$(Build.ArtifactStagingDirectory)'
          versioningScheme: 'byEnvVar'
          versionEnvVar: artifactVersion

      - task: DotNetCoreCLI@2
        displayName: 'Push NuGet Package to Artifact'
        inputs:
          command: 'push'
          publishVstsFeed: '92d7f46c-db9b-4ce4-9eb9-1d02c9b3e668/7443abf4-fbf7-43fa-9b0a-800e4e335c00'
          packagesToPush: '$(Build.ArtifactStagingDirectory)/*.nupkg'
          nuGetFeedType: 'internal'
